# 硬盘

> 磁盘→盘片→磁道→扇区(每个 512 字节)

![image](https://piachh.cn/show?pic=pics/disk.jpg)

# ext文件系统

## inode与块

- 块(block)，是扇区大小的整数倍，默认4K。
- 块用于存储文件的**数据部分**，因此一个文件的数据是散落在很多不连续的块上的。
- 因此需要额外的数据来做索引，这就是inode(i for index)。
- inode是文件的**元数据部分**，包含名字、权限等。
- 文件夹(目录)本身也是一个文件，也有自己的inode。

```
// ls命令的信息取自于此
struct ext4_inode {
	__le16	i_mode;		/* File mode */  //权限
	__le16	i_uid;		/* Low 16 bits of Owner Uid */  //属于哪个用户
	__le32	i_size_lo;	/* Size in bytes */
	__le32	i_atime;	/* Access time */  //最近一次访问文件的时间
	__le32	i_ctime;	/* Inode Change time */  //最近一次更改inode时间（修改元数据部分）
	__le32	i_mtime;	/* Modification time */ //最近一次更改文件内容时间（修改数据部分）
	__le32	i_dtime;	/* Deletion Time */
	__le16	i_gid;		/* Low 16 bits of Group Id */
	__le16	i_links_count;	/* Links count */
	__le32	i_blocks_lo;	/* Blocks count */
	__le32	i_flags;	/* File flags */
......
	__le32	i_block[EXT4_N_BLOCKS];/* Pointers to blocks */ //块索引!
	__le32	i_generation;	/* File version (for NFS) */
	__le32	i_file_acl_lo;	/* File ACL */
	__le32	i_size_high;
......
};


// 其中EXT4_N_BLOCKS：
#define	EXT4_NDIR_BLOCKS		12
#define	EXT4_IND_BLOCK			EXT4_NDIR_BLOCKS
#define	EXT4_DIND_BLOCK			(EXT4_IND_BLOCK + 1)
#define	EXT4_TIND_BLOCK			(EXT4_DIND_BLOCK + 1)
#define	EXT4_N_BLOCKS			(EXT4_TIND_BLOCK + 1)
```

## 索引组织
从上面代码看到，索引存储在一个数组中，那么如何安排分配这个数量有限的数组呢：

- ext2/ext3中，前12项直接保存块地址，i_block[0-11]。
- 文件较大时，i_block[12]用于指向一个**间接块**。
- 文件巨大，i_block[13/14]分别指向二级、三级间接块。

![image](https://piachh.cn/show?pic=pics/ext2_inode.jpeg)

- ext4使用树(**Extents**)来扩展，提高了查询效率。

## 文件系统整体结构

> 使用位图来快速找到空闲的inode/块

- 使用一个块保存inode的位图;
- 使用一个块保存block的位图；(共128M)
- 以上组成一个**块组**
- **超级块**用于描述整个文件系统的情况
- 第一个块组前预留1K作为引导区

![image](https://piachh.cn/show?pic=pics/disk_groups.jpeg)

## 软链接和硬链接

- 硬链接与原始文件公用一个inode。
- 软连接相当于重新创建了一个文件，有独立的inode。

## 目录和文件

![image](https://piachh.cn/show?pic=pics/disk_dir_file.png)
# CPU cache

## 为什么需要高速缓存

- 这里的高速缓存指的是实实在在的SRAM；
- CPU速度与内存(DRAM)访问速度差距越来越大，现在两者已有120倍差距；
- 为了减少CPU傻等内存的情况，引入高速缓存；
- 95%情况下，CPU都可以从L1-L3 cache拿到指令和数据，而不是内存；

### Cache Line

- CPU从内存读数据到cache过程中，是以缓存块(cache line)为粒度的。
- 在intel服务器或PC中，cache line通常是64Byte。

## 怎么使用Cache

- 无论数据是否在cache里，CPU都先访问cache；
- 若发现cache中没有，才会访问内存，并读到cache里；

### 直接映射Cache

将内存地址映射到cache地址，通常是通过mod运算！

> 技巧：将缓存块数量设置为2的N次方，则对内存地址求余过程可以简化为取内存地址2进制表示的低N位！（比如缓存块有2^3=8块，则内存地址21对应的缓存块是b'101'=5。）

![image](https://github.com/ingangi/blog/blob/master/img/cpu_cache_dir_map.png)

#### 缓存块中有什么？

1. 组标记（tag）：记录当前缓存块对应的内存块地址的高M-N位；
2. 有效位（valid bit）：数据是否有效；
3. 数据；

#### 读取流程

1. 根据内存地址低N位，计算在cache中的索引；
2. 判断有效位；
3. 对比内存地址高位和组标记，判断是否是想要的内存地址的数据，得到data block；
4. 根据offset从data block中读到想要的字。

![image](https://github.com/ingangi/blog/blob/master/img/cpu_cache_dir_map_read.png)